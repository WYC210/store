"use strict";(self["webpackChunkstore"]=self["webpackChunkstore"]||[]).push([[376],{8376:function(e,a,r){r.r(a),r.d(a,{default:function(){return y}});r(4114);var l=r(6768),o=r(144),s=r(4232),n=r(973),d=r(4783),t=r(1219),u=r(1419),i=(r(1454),r(5720));function p(e){return(0,i.A)({url:"/users/update",method:"patch",data:{phone:e.phone,email:e.email,gender:e.gender},withCredentials:!0,headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}})}const c=e=>(0,i.A)({url:"/users/password",method:"patch",data:{oldPassword:e.oldPassword,newPassword:e.newPassword},withCredentials:!0,headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}}),g={class:"profile-container"},m={class:"profile-header"},f={class:"avatar-container"},w={class:"profile-content"},b={key:0,class:"edit-form"},k={class:"action-buttons"},h={class:"dialog-footer"};var v={__name:"index",setup(e){const a=(0,n.rd)(),r=(0,d.k)(),i=(0,o.KR)(!1),v=(0,o.KR)(null),P=(0,o.KR)(null),_=(0,o.Kh)({phone:r.userInfo?.phone||"",email:r.userInfo?.email||"",gender:r.userInfo?.gender||0}),y={email:[{required:!0,message:"请输入邮箱地址",trigger:"blur"},{type:"email",message:"请输入正确的邮箱地址",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号",trigger:"blur"}]},F=(0,o.Kh)({visible:!1,loading:!1}),I=(0,o.KR)({oldPassword:"",newPassword:"",confirmPassword:""}),V={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"},{min:6,max:20,message:"密码长度在 6 到 20 个字符",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:20,message:"密码长度在 6 到 20 个字符",trigger:"blur"},{validator:(e,a,r)=>{a===I.value.oldPassword?r(new Error("新密码不能与原密码相同")):r()},trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(e,a,r)=>{a!==I.value.newPassword?r(new Error("两次输入的密码不一致")):r()},trigger:["blur","change"]}]},R=e=>e?new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"暂无数据",W=()=>{F.visible=!0,I.oldPassword="",I.newPassword="",I.confirmPassword=""},C=(0,o.KR)(!1),L=e=>{switch(e){case 1:return"男";case 2:return"女";case 0:default:return"保密"}},q=()=>{C.value=!0,_.phone=r.userInfo?.phone||"",_.email=r.userInfo?.email||"",_.gender=r.userInfo?.gender||0},U=()=>{C.value=!1,_.phone=r.userInfo?.phone||"",_.email=r.userInfo?.email||"",_.gender=r.userInfo?.gender||0},E=async()=>{try{i.value=!0,await v.value.validate();const e=await p({phone:_.phone,email:_.email,gender:_.gender});if(200!==e.state)throw new Error(e.message||"更新用户信息失败");t.nk.success("保存成功"),r.setUserInfo(e.data)}catch(e){console.error("Save error:",e),400===e.response?.data?.state?t.nk.warning(e.response.data.message):t.nk.error(e.message||"保存失败")}finally{i.value=!1}},K=async()=>{try{if(await P.value.validate(),I.value.newPassword!==I.value.confirmPassword)return void t.nk.error("两次输入的新密码不一致");console.log("Password update request data:",{url:"/users/password",method:"PATCH",headers:{"Content-Type":"application/json",Accept:"application/json","AUTH-TOKEN":(0,u.Ri)("token")},data:{oldPassword:I.value.oldPassword,newPassword:I.value.newPassword}});const e=await c({oldPassword:I.value.oldPassword,newPassword:I.value.newPassword});console.log("Password update response:",e),200===e.state&&(t.nk.success("密码修改成功"),F.visible=!1,I.value={oldPassword:"",newPassword:"",confirmPassword:""})}catch(e){console.log("Password update error:",{error:e,response:e.response?.data,message:e.message}),e.response?.data?.message?t.nk.error(e.response.data.message):e.message?t.nk.error(e.message):t.nk.error("修改密码失败，请重试")}},T=e=>{const a="image/jpeg"===e.type||"image/png"===e.type,r=e.size/1024/1024<2;return a||t.nk.error("头像只能是 JPG 或 PNG 格式!"),r||t.nk.error("头像大小不能超过 2MB!"),a&&r},X=e=>{200===e.state?(r.setUserInfo({...r.userInfo,avatar:e.data.avatar}),t.nk.success("头像更新成功")):t.nk.error("头像更新失败")},x=async()=>{try{await r.logout(),t.nk.success("退出成功"),a.push("/login")}catch(e){console.error("Logout failed:",e),t.nk.error("退出失败")}};async function A(){try{const r=(0,d.k)();if(i.value=!0,r.isLoggedIn)return j(r.userInfo),!0;try{const e=await r.validateToken();if(!e)throw new Error("验证失败");return j(r.userInfo),!0}catch(e){throw t.nk.warning("请先登录"),a.push("/login"),new Error("未登录")}}catch(e){throw console.error("Auth check failed:",e),(0,u.zs)("token"),e}finally{i.value=!1}}function j(e){e&&(_.phone=e.phone||"",_.email=e.email||"",_.gender=e.gender||0,console.log("用户信息已更新:",{phone:_.phone,email:_.email,gender:_.gender}))}return(0,l.sV)((async()=>{try{await A()}catch(e){console.error("初始化认证检查失败:",e)}})),(e,a)=>{const n=(0,l.g2)("el-avatar"),d=(0,l.g2)("el-upload"),t=(0,l.g2)("el-descriptions-item"),u=(0,l.g2)("el-descriptions"),p=(0,l.g2)("el-input"),c=(0,l.g2)("el-form-item"),A=(0,l.g2)("el-radio"),j=(0,l.g2)("el-radio-group"),z=(0,l.g2)("el-button"),H=(0,l.g2)("el-form"),M=(0,l.g2)("el-card"),N=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.CE)("div",g,[(0,l.bF)(M,{class:"profile-card"},{default:(0,l.k6)((()=>[(0,l.Lk)("div",m,[(0,l.Lk)("div",f,[(0,l.bF)(d,{class:"avatar-uploader",action:"/api/users/avatar","show-file-list":!1,"on-success":X,"before-upload":T},{default:(0,l.k6)((()=>[(0,l.bF)(n,{size:100,src:(0,o.R1)(r).userInfo?.avatar||"/default-avatar.png"},null,8,["src"]),a[8]||(a[8]=(0,l.Lk)("div",{class:"avatar-hover-text"},"点击更换头像",-1))])),_:1})]),a[9]||(a[9]=(0,l.Lk)("h2",null,"个人中心",-1))]),(0,l.Lk)("div",w,[(0,l.bF)(H,{ref_key:"formRef",ref:v,model:_,rules:y,"label-width":"120px"},{default:(0,l.k6)((()=>[(0,l.bF)(u,{column:1,border:""},{default:(0,l.k6)((()=>[(0,l.bF)(t,{label:"用户ID"},{default:(0,l.k6)((()=>[(0,l.eW)((0,s.v_)((0,o.R1)(r).userInfo?.uid),1)])),_:1}),(0,l.bF)(t,{label:"用户名"},{default:(0,l.k6)((()=>[(0,l.eW)((0,s.v_)((0,o.R1)(r).userInfo?.username),1)])),_:1}),(0,l.bF)(t,{label:"用户权限"},{default:(0,l.k6)((()=>[(0,l.eW)((0,s.v_)("admin"===(0,o.R1)(r).userInfo?.power?"管理员":"普通用户"),1)])),_:1}),(0,l.bF)(t,{label:"手机号码"},{default:(0,l.k6)((()=>[(0,l.eW)((0,s.v_)((0,o.R1)(r).userInfo?.phone||"暂未设置"),1)])),_:1}),(0,l.bF)(t,{label:"邮箱"},{default:(0,l.k6)((()=>[(0,l.eW)((0,s.v_)((0,o.R1)(r).userInfo?.email||"暂未设置"),1)])),_:1}),(0,l.bF)(t,{label:"性别"},{default:(0,l.k6)((()=>[(0,l.eW)((0,s.v_)(L((0,o.R1)(r).userInfo?.gender)),1)])),_:1}),(0,l.bF)(t,{label:"注册时间"},{default:(0,l.k6)((()=>[(0,l.eW)((0,s.v_)(R((0,o.R1)(r).userInfo?.createdTime)),1)])),_:1})])),_:1}),C.value?((0,l.uX)(),(0,l.CE)("div",b,[(0,l.bF)(c,{label:"手机号码",prop:"phone"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:_.phone,"onUpdate:modelValue":a[0]||(a[0]=e=>_.phone=e),placeholder:"请输入手机号码"},null,8,["modelValue"])])),_:1}),(0,l.bF)(c,{label:"邮箱",prop:"email"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:_.email,"onUpdate:modelValue":a[1]||(a[1]=e=>_.email=e),placeholder:"请输入邮箱"},null,8,["modelValue"])])),_:1}),(0,l.bF)(c,{label:"性别"},{default:(0,l.k6)((()=>[(0,l.bF)(j,{modelValue:_.gender,"onUpdate:modelValue":a[2]||(a[2]=e=>_.gender=e)},{default:(0,l.k6)((()=>[(0,l.bF)(A,{label:1},{default:(0,l.k6)((()=>a[10]||(a[10]=[(0,l.eW)("男")]))),_:1}),(0,l.bF)(A,{label:2},{default:(0,l.k6)((()=>a[11]||(a[11]=[(0,l.eW)("女")]))),_:1}),(0,l.bF)(A,{label:0},{default:(0,l.k6)((()=>a[12]||(a[12]=[(0,l.eW)("保密")]))),_:1})])),_:1},8,["modelValue"])])),_:1})])):(0,l.Q3)("",!0),(0,l.Lk)("div",k,[C.value?((0,l.uX)(),(0,l.CE)(l.FK,{key:1},[(0,l.bF)(z,{type:"primary",onClick:E,loading:i.value},{default:(0,l.k6)((()=>a[14]||(a[14]=[(0,l.eW)(" 保存 ")]))),_:1},8,["loading"]),(0,l.bF)(z,{onClick:U},{default:(0,l.k6)((()=>a[15]||(a[15]=[(0,l.eW)(" 取消 ")]))),_:1})],64)):((0,l.uX)(),(0,l.Wv)(z,{key:0,type:"primary",onClick:q},{default:(0,l.k6)((()=>a[13]||(a[13]=[(0,l.eW)(" 编辑资料 ")]))),_:1})),(0,l.bF)(z,{type:"primary",onClick:W},{default:(0,l.k6)((()=>a[16]||(a[16]=[(0,l.eW)(" 修改密码 ")]))),_:1}),(0,l.bF)(z,{type:"danger",onClick:x},{default:(0,l.k6)((()=>a[17]||(a[17]=[(0,l.eW)(" 退出登录 ")]))),_:1})])])),_:1},8,["model"])])])),_:1}),(0,l.bF)(N,{modelValue:F.visible,"onUpdate:modelValue":a[7]||(a[7]=e=>F.visible=e),title:"修改密码",width:"400px"},{footer:(0,l.k6)((()=>[(0,l.Lk)("span",h,[(0,l.bF)(z,{onClick:a[6]||(a[6]=e=>F.visible=!1)},{default:(0,l.k6)((()=>a[18]||(a[18]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(z,{type:"primary",onClick:K,loading:F.loading},{default:(0,l.k6)((()=>a[19]||(a[19]=[(0,l.eW)(" 确认修改 ")]))),_:1},8,["loading"])])])),default:(0,l.k6)((()=>[(0,l.bF)(H,{ref_key:"passwordFormRef",ref:P,model:I.value,rules:V,"label-width":"100px"},{default:(0,l.k6)((()=>[(0,l.bF)(c,{label:"原密码",prop:"oldPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:I.value.oldPassword,"onUpdate:modelValue":a[3]||(a[3]=e=>I.value.oldPassword=e),type:"password","show-password":"",placeholder:"请输入原密码"},null,8,["modelValue"])])),_:1}),(0,l.bF)(c,{label:"新密码",prop:"newPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:I.value.newPassword,"onUpdate:modelValue":a[4]||(a[4]=e=>I.value.newPassword=e),type:"password","show-password":"",placeholder:"请输入新密码"},null,8,["modelValue"])])),_:1}),(0,l.bF)(c,{label:"确认新密码",prop:"confirmPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(p,{modelValue:I.value.confirmPassword,"onUpdate:modelValue":a[5]||(a[5]=e=>I.value.confirmPassword=e),type:"password","show-password":"",placeholder:"请再次输入新密码"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}},P=r(1241);const _=(0,P.A)(v,[["__scopeId","data-v-78008c60"]]);var y=_}}]);
//# sourceMappingURL=376.89c84ea9.js.map